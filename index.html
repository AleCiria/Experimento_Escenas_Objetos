//////////////////////////////////////////////
///////// Experimento Tesis Rebe /////////////
//////////////////////////////////////////////

// Claridad del recuerdo = objetos congruentes e incongruentes con el contexto
// Versión jsPsych 7.3.3
// Se usa DataPipe (plugin), GitHub, y OSF
// Fecha 08/10/23
// Github Rebe 27-10-23
//////////////////////////////////////////////

<!DOCTYPE html>
<html>
  <head>
    <title>Tarea escenas objetos</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-animation@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script type="text/javascript" src="Stim_List_1.js"></script>
    <script type="text/javascript" src="Stim_List_2.js"></script>
    <script type="text/javascript" src="stim_list_P_1.js"></script>
    <script type="text/javascript" src="stim_list_P_2.js"></script>
    <script type="text/javascript" src="stim_list_T_1.js"></script>
    <script type="text/javascript" src="stim_list_T_2.js"></script>
    <script type="text/javascript" src="stim_list_T_3.js"></script>
    <script type="text/javascript" src="stim_list_T_P_1.js"></script>
    <script type="text/javascript" src="stim_list_T_P_2.js"></script>
    <script type="text/javascript" src="stim_list_T_P_3.js"></script>

    <script language="javascript"></script>  
  </head>
  <body></body>
  <script>  


///// Plugins usados /////

// jsPsychHtmlButtonResponse
// jsPsychPreload
// jsPsychFullscreen
// jsPsychSurveyText
// jsPsychSurveyMultiChoice
// jsPsychInstructions
// jsPsychHtmlKeyboardResponse
// jsPsychCallFunction
// jsPsychAnimation
// jsPsychImageKeyboardResponse
// jsPsychImageButtonResponse
// 


var jsPsych = initJsPsych({});

/* Se genera un ID para cada participante de forma aleatoria con 8 caracteres alfanuméricos */
const subject_id = jsPsych.randomization.randomID(8);
jsPsych.data.addProperties({subject_id: subject_id});


var timeline = [];


//se crea el primer ramdom Condition de las opciones para la fase de exposición 
var primer_random = jsPsych.randomization.sampleWithoutReplacement([1, 2], 1)[0];

jsPsych.data.addProperties({condicion_fase_1: primer_random});



//La tarea tarda un poco en cargar, gracias por tu paciencia

var aviso = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p><div style ="font-size: 20px;"><strong> La tarea comenzará a cargarse al dar click en el botón de "continuar", esto puede tardar unos segundos. </p><p>Gracias por tu paciencia. </p></strong></div>',
  choices: ['CONTINUAR']
};
timeline.push(aviso);



// Se crea la variable "imagenes" para cargarlas antes del experimento
var instru_imagenes = ["CONSENTIMIENTO.jpg","BIENVENIDA.jpg","INSTRUCCIONES.jpg","teclado_1.jpg","instrucciones_b_1.jpg","instrucciones_b_2.jpg","dedos_1.jpg",
"instrucciones_t.jpg","instrucciones_t_1.jpg","instrucciones_t_2.jpg","instrucciones_t_3.jpg","instrucciones_teclas_1.jpg","instrucciones_teclas_2.jpg","instrucciones_teclas_3.jpg","ejemplo_1.jpg","ejemplo_2.jpg","ejemplo_3.jpg", "teclado_2.jpg","dedos_2.jpg","feedback_t_a.jpg","feedback_t_s.jpg",
];

    // Se cargan los elementos de "imagenes" antes de iniciar el experimento
var preload_1 = {
    type: jsPsychPreload,
    images: instru_imagenes
};
timeline.push(preload_1);


// Se crea la variable "imagenes" para cargarlas antes del experimento
var escenas_imagenes = ["airplane_interior_A.jpg","art_gallery_A.jpg","bakery_A.jpg","ballet_room_A.jpg","bar_A.jpg","bedroom_B.jpg","boat_interior_A.jpg","boxing_ring_A.jpg","building_stairs_B.jpg","car_interior_A.jpg","casino_B.jpg",
    "childrens_room_A.jpg","church_B.jpg","classroom_A.jpg","clinic_A.jpg","flower_shop_B.jpg","gymnasium_A.jpg","hair_salon_A.jpg","hospital_room_A.jpg","hotel_lobby_B.jpg","ice_rink_B.jpg","jewelery_A.jpg","kitchen_B.jpg",
    "laboratory_B.jpg","laundry_A.jpg","library_A.jpg","living_room_B.jpg","meeting_room_B.jpg","movie_theater_A.jpg","museum_B.jpg","office_work_B.jpg","orchard_B.jpg","painting_workshop_B.jpg",
    "parking_lot_B.jpg","prison_A.jpg","public_toilet_A.jpg","restaurant_A.jpg","sewing_workshop_B.jpg","shoe_store_A.jpg","shopping_center_B.jpg","theater_A.jpg","vault_A.jpg","waiting_room_A.jpg","warehouse_A.jpg",
    "airplane_interior_A_CON.jpg","art_gallery_A_INC.jpg","bakery_A_CON.jpg","ballet_room_A_INC.jpg","bar_A_CON.jpg","bedroom_B_INC.jpg","boat_interior_A_INC.jpg","boxing_ring_A_CON.jpg","building_stairs_B_CON.jpg",
    "car_interior_A_INC.jpg","casino_B_CON.jpg","childrens_room_A_INC.jpg","church_B_INC.jpg","classroom_A_CON.jpg","clinic_A_CON.jpg","flower_shop_B_CON.jpg","gymnasium_A_CON.jpg","hair_salon_A_CON.jpg","hospital_room_A_INC.jpg",
    "hotel_lobby_B_CON.jpg","ice_rink_B_CON.jpg","jewelery_A_CON.jpg","kitchen_B_CON.jpg","laboratory_B_INC.jpg","laundry_A_INC.jpg","library_A_INC.jpg","living_room_B_INC.jpg","meeting_room_B_CON.jpg","movie_theater_A_INC.jpg",
    "museum_B_INC.jpg","office_work_B_INC.jpg","orchard_B_INC.jpg","painting_workshop_B_CON.jpg","parking_lot_B_INC.jpg","prison_A_INC.jpg","public_toilet_A_CON.jpg","restaurant_A_CON.jpg","sewing_workshop_B_CON.jpg","shoe_store_A_CON.jpg",
    "shopping_center_B_INC.jpg","theater_A_CON.jpg","vault_A_INC.jpg","waiting_room_A_CON.jpg","warehouse_A_INC.jpg",
    
    "beach_A.jpg","beach_A_CON.jpg","desert_B.jpg","desert_B_INC.jpg","skate_park_B.jpg","skate_park_B_CON.jpg","cemetery_B.jpg","cemetery_B_INC.jpg"];

    // Se cargan los elementos de "imagenes" antes de iniciar el experimento
var preload_2 = {
    type: jsPsychPreload,
    images: escenas_imagenes
};
timeline.push(preload_2);

// Se crea la variable "imagenes" para cargarlas antes del experimento
var objetos_imagenes = ["armchair_SIMILAR.jpg","bikini_SIMILAR.jpg","binoculars_SIMILAR.jpg","bottle_SIMILAR.jpg","boxing_glove_SIMILAR.jpg","clock_SIMILAR.jpg",
    "dice_SIMILAR.jpg","fork_SIMILAR.jpg","grater_SIMILAR.jpg","hairdryer_SIMILAR.jpg","jar_SIMILAR.jpg",
    "jewelry_box_SIMILAR.jpg","poker_chips_SIMILAR.jpg","racket_SIMILAR.jpg","rolling_pin_SIMILAR.jpg","roman_helmet_SIMILAR.jpg",
    "saw_SIMILAR.jpg","scooter_SIMILAR.jpg","tiara_SIMILAR.jpg","weights_SIMILAR.jpg","whelk_SIMILAR.jpg","whistle_SIMILAR.jpg",
    "brocha_NUEVO.jpg","calcetas_NUEVO.jpg","casco_bici_NUEVO.jpg","cepillo_NUEVO.jpg","chupon_NUEVO.jpg","cup_NUEVO.jpg",
    "engrapadora_NUEVO.jpg","googles_NUEVO.jpg","gorra_NUEVO.jpg","guante_cocina_NUEVO.jpg","licuadora_NUEVO.jpg","linterna_NUEVO.jpg",
    "marco_NUEVO.jpg","munieca_NUEVO.jpg","palita_NUEVO.jpg","pandero_NUEVO.jpg","pinzas_NUEVO.jpg","pinia_NUEVO.jpg","silla_NUEVO.jpg",
    "sombrero_NUEVO.jpg","tazon_NUEVO.jpg","vela_NUEVO.jpg",
    "airplane_belt.jpg","appointment_book.jpg","balloons.jpg","beach_umbrella.jpg",
    "blackboard_eraser.jpg","cactus.jpg","chaplet.jpg","color_palette.jpg","dagger.jpg","emergency_exit_signal.jpg","fire_hydrant.jpg",
    "hose.jpg","ice_skates.jpg","luggage_carrier_cart.jpg","magic_cube.jpg","scythe.jpg",
    "shoe_box.jpg","soap_dispenser.jpg","stethoscope.jpg","thimble.jpg","tragedy_mask.jpg","trampoline.jpg","objeto_1.jpg","objeto_2.jpg",
  
    "objeto_1.jpg","objeto_2.jpg","objeto_3.jpg"];

// Se cargan los elementos de "imagenes" antes de iniciar el experimento
var preload_3 = {
    type: jsPsychPreload,
    images: objetos_imagenes
};
timeline.push(preload_3);



// Pantalla completa
timeline.push({
  type: jsPsychFullscreen,
  message: "<p>Presiona el botón para cambiar a pantalla completa<p>",
  button_label:	'CONTINUAR',
  fullscreen_mode: true
});


//////////////////////////////////////////////////////////////
///////// CONSENTIMIENTO INFORMADO y BIENVENIDA //////////////
/////////////////////////////////////////////////////////////

// Agregar código para presentar la imagen del consentimiento INFORMADO

timeline.push({
  type:jsPsychImageButtonResponse,
  stimulus: "CONSENTIMIENTO.jpg",
  stimulus_height: 650,
  maintain_aspect_ratio: true,
  choices: ["<div style='font-size: 25px;'>ACEPTO</div>"],
});

// Texto de BIENVENIDA al experimento

timeline.push({
  type:jsPsychImageButtonResponse,
  stimulus: "BIENVENIDA.jpg",
  stimulus_height: 600,
  maintain_aspect_ratio: true,
  choices: ["<div style='font-size: 25px;'>CONTINUAR</div>"],
});

//////////////////////////////////////////////
///////// DATOS PARTICIPANTE ////////////////
//////////////////////////////////////////////

var edad = {
  type: jsPsychSurveyText,
  button_label:"CONTINUAR",
  preamble: "<div style='font-size: 20px;'><strong>¿Cuántos años tienes?</strong></div>",
  questions: [
    {
      prompt: 'Por favor, escribe tu edad en números (ejemplo: 22)',
      name:'edad',
      required: true,
    },
  ]
};

var genero = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>¿Con qué género te identificas?</strong></div>", 
      name: 'genero', 
      options: ['FEMENINO', 'MASCULINO', 'OTRO'], 
      required: true,
    }
  ],
};

var nacionalidad = {
  type: jsPsychSurveyText,
  button_label:"CONTINUAR",
  preamble: "<div style='font-size: 20px;'><strong>¿Cuál es tu nacionalidad?</strong></div>",
  questions: [
    {
      prompt: 'Por favor, escribe tu nacionalidad con minúsculas y en femenino (ejemplo: mexicana)',
      name:'nacionalidad',
      required: true,
    },
  ]
};
    
var escolaridad = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>¿Cuál es tu grado de escolaridad?</strong> (último grado cursado o cursando actualmente)?</div>", 
      name: 'escolaridad', 
      options: ['PRIMARIA', 'SECUNDARIA', 'BACHILLERATO', 'LICENCIATURA', 'POSGRADO'], 
      required: true,
    }
  ],
};
    
var vision = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><p><strong> Indica si tu visión es Normal o Corregida</strong></p><p>Corregida quiere decir que utilizas lentes o lentes de contacto, tuviste alguna operación para corregirla, etc.</p></div>", 
      name: 'vision', 
      options: ['NORMAL', 'CORREGIDA'], 
      required: true,
    }
  ],
};

var color = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><p><strong> Hasta tu conocimiento, ¿cuentas con alguna condición que pudiera alterar tu percepción de los colores?</strong></p></div>", 
      name: 'vision', 
      options: ['SI', 'NO'], 
      required: true,
    }
  ],
};    

var lateralidad = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>¿Cuál es tu mano dominante?</strong><p>Es decir la mano con la que escribes</p></div>", 
      name: 'lateralidad', 
      options: ['DERECHA', 'IZQUIERDA', 'AMBAS'], 
      required: true,
    }
  ],
};

    
timeline.push(edad,genero,nacionalidad,escolaridad,vision,color,lateralidad);


//////////////////////////////////////////////
///////// INICIA FASE DE EXPOSICIÓN ///////////
//////////////////////////////////////////////

// Se presenta una imagen con las INSTRUCCIONES del experimento

var instrucciones_contra;

if (primer_random == 1) {
  instrucciones_contra = "instrucciones_b_1.jpg";
} else if (primer_random == 2) {
  instrucciones_contra = "instrucciones_b_2.jpg";
}


////////////cargar nuevas imagenes de instrucciones **********////////

var instrucciones = {
  type: jsPsychInstructions,
  pages: [
    '<img src="INSTRUCCIONES.jpg" style="width: 950px; height: auto;"></img>',
    '<br>' + 
    '<img src="' + "teclado_1.jpg" + '" style="width: 950px; height: auto;"></img>',
    '<br>' +
    '<img src="' + instrucciones_contra + '" style="width: 950px; height: auto;"></img>'
  ],
  button_label_next: "CONTINUAR",
  button_label_previous: "ANTERIOR",
  show_clickable_nav: true,
  allow_keys: false
};

//////// ********** AGREGAAAAAAAAAAR *********** cargar teclado

var inicio_practica = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div style="font-size:25px;"><strong>Coloca tus dedos sobre las teclas “V” y “N”,</p><p>cuando estés list@, presiona cualquiera de ellas para comenzar la práctica :)</p> </strong></div>',
  choices: ["v","n"]
};
timeline.push(instrucciones,inicio_practica);


//////Estimulos de práctica con retroalimentación///////////

//Quitar cursor utilizando un estilo css cargado como "no_mouse.css"
var cursor_off= {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "none";
  }
};
timeline.push(cursor_off);

// Cruz de fijación
var fixation = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div style="font-size:80px;color:red;">+</div>',
  choices: "NO_KEYS",
  trial_duration: 600
};

var practica = {
  type: jsPsychAnimation,
  stimuli: jsPsych.timelineVariable('stimulus'),
  frame_time: 1500,
  choices: "NO_KEYS",
  render_on_canvas: true
};

//////// *********AGREGGAAAAAAAR JS*************///////////////

// Definir texto_practica dependiendo de primer_random
var texto_practica;

if (primer_random == 1) {
  texto_practica = "<p><strong>CONGRUENTE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>INCONGRUENTE</strong></p>"; Stim_List_P = Stim_List_P_1;
} else if (primer_random == 2) {
  texto_practica = "<p><strong>INCONGRUENTE</strong>&nbsp;&nbsp;&nbsp;<strong>CONGRUENTE</strong></p>" ; Stim_List_P = Stim_List_P_2
}

////////////AGREGAAAAAAAAAAR ***** JS STIM_LIST_P1

// Mostrar el texto y recoger la respuesta del participante
var practica_response = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: texto_practica,
  choices: ["v", "n"],
  trial_duration: 3000,
  
  data: {
     task: 'congruencia_p_1',
     correct_response: jsPsych.timelineVariable('correct_response'),
     tipo_estimulo: jsPsych.timelineVariable('tipo')
  },
  
  on_finish: function(data) {
    if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
      data.correct = true;
    } else {
      data.correct = false;
    }
  }
};

// Retroalimentación para la respuesta correcta

var feedback_1 = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 2000,
  choices:"NO_KEYS",
  stimulus: function() {
    var last_trial = jsPsych.data.get().last(1).values()[0];
    var tipo_estimulo = last_trial.tipo_estimulo;
    
    if (tipo_estimulo == "1") {
      if (last_trial.correct) {
        return '<div style="font-size:25px;color:green;">¡Correcto! Para esta escena la respuesta es <strong style="color:black;">congruente</strong></div>';
      } else {
        return '<div style="font-size:25px;color:red;">Incorrecto, para esta escena la respuesta es <strong style="color:black;">congruente</strong></div>';
      }
    } else if (tipo_estimulo == "2") {
      if (last_trial.correct) {
        return '<div style="font-size:25px;color:green;">¡Correcto! Para esta escena la respuesta es <strong style="color:black;">incongruente</strong></div>';
      } else {
        return '<div style="font-size:25px;color:red;">Incorrecto, para esta escena la respuesta es <strong style="color:black;">incongruente</strong></div>';
      }
    }
  }
};

// Crear un procedimiento que repita la secuencia de estímulos
var procedimiento_practica = {
  timeline: [fixation, practica, practica_response, feedback_1],
  timeline_variables: Stim_List_P,
  randomize_order: true,
};

timeline.push(procedimiento_practica);


// Agregar cursor de nuevo después de procedimiento_practica
var cursor_on = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "auto";
  }
};
timeline.push(cursor_on);

//////////LOOP///////////


// Repetir instrucciones y práctica si el participante lo considera necesario 
var repetir_practica = {
  type: jsPsychSurveyMultiChoice,
  button_label: 'CONTINUAR',
  name: 'Repetir_practica', 
  questions: [
    {prompt: '<p style= "font-size:25px;"><strong> Has finalizado la práctica.</strong></p><p>Si te quedó alguna duda, selecciona la opción de "REPETIR" para volver a leer las intrucciones y realizar de nuevo la práctica.</p><p>Si todo está claro, selecciona "ACTIVIDAD".</p>', options: ["REPETIR", "ACTIVIDAD"], required: true}
  ]
};
timeline.push(repetir_practica);

// Condicional para repetir instrucciones y práctica 
var repetir_loop = {
  timeline: [instrucciones, inicio_practica, cursor_off, procedimiento_practica, cursor_on, repetir_practica],
  conditional_function: function() {
    var dat = jsPsych.data.getLastTrialData().values()[0];
    var answer = dat.response.Q0;
    if(answer.includes("REPETIR") == true) {
      return true;
    } else {
      return false;
    }
  },
}
timeline.push(repetir_loop);


//////////INICIO TAREA ///////////

var inicio_tarea ={
  type: jsPsychHtmlKeyboardResponse,
  stimulus:'<div style="font-size:25px;"><strong>¡Has concluido la práctica!</strong></p><p><strong>Para comenzar la tarea completa,</strong> por favor coloca tus dedos como lo hiciste en la práctica sobre las teclas “V” y “N” <p>Cuando estés list@, ¡presiona cualquiera de ellas para comenzar! :)</p></strong></div>',
  choices: ["v","n"],
};
timeline.push(inicio_tarea);

var cursor_off = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "none";
  }
};
timeline.push(cursor_off);

////////////////////////////////////
/////////INICIO FASE EXPO///////////
////////////////////////////////////

if (primer_random == 1) {
  texto_respuestas = "<p><strong>CONGRUENTE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>INCONGRUENTE</strong></p>"; Stim_List= Stim_List_1;
} else if (primer_random == 2) {
  texto_respuestas = "<p><strong>INCONGRUENTE</strong>&nbsp;&nbsp;&nbsp;<strong>CONGRUENTE</strong></p>"; Stim_List= Stim_List_2
};

//////agregarrrrrrr js actualizadosssss ***** /////

/////////////ANIMATION//////////////

var test_trial= {
  type: jsPsychAnimation,
  stimuli: jsPsych.timelineVariable('stimulus'),
  frame_time: 1500,
  choices: "NO_KEYS",
  render_on_canvas: true
};


///////////RESPUESTAS////////////

var respuestas_trial = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: texto_respuestas,
  choices: ['n', 'v'],
  trial_duration: 3000,
  data: { //se establecen los datos que se quieren registrar de la variable ensayo, respuesta del participante, cuál era la respuesta correcta, etc)
     task: 'congruencia',
     correct_response: jsPsych.timelineVariable('correct_response'),
     tipo_estimulo: jsPsych.timelineVariable('tipo')
    },
    on_finish: function(data){ //al finalizar cada ensayo mediante este pluginAPI se compara la respuesta asignada a 'data' que provienen de lo almacenado en task: 'response', con la respuesta corecta correct_response y se almacena en la variable data.correct
      data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
    }
  }; 

//////////////// PROCEDIMIENTO/////////////

var procedimiento = {
  timeline: [fixation, test_trial, respuestas_trial],
  timeline_variables: Stim_List,
  randomize_order: true,
};
timeline.push(procedimiento);

//////////FIN EXPO////////////

//Agregar cursor de nuevo
var cursor_on = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "auto";
  }
};
timeline.push(cursor_on);


//Conclusion_1 escrita para ahorrar archivos de imagenes
//se le indica al participante que terminó la fase de prueba
var conclusion_1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style="font-size:30px;"><strong>¡Has concluido la primera sección de la tarea!</strong><p>Para continuar, por favor presiona el botón</p>',
  choices: ['CONTINUAR']
};
timeline.push(conclusion_1)

///////////////////////////////////////////////////////
///////INICIO SEGUNDA SECCION TAREA DE MEMORIA/////////
///////////////////////////////////////////////////////

// Seleccionar una condición aleatoria (segundo_random) para 3 opciones 

var segundo_random = jsPsych.randomization.sampleWithoutReplacement([1, 2, 3], 1)[0];

jsPsych.data.addProperties({condicion_fase_2: segundo_random});


///////instrucciones/////////////

if (segundo_random == 1) {
  instrucciones_2 = "instrucciones_teclas_1.jpg"; ejemplo = "ejemplo_1.jpg"; texto_respuestas = "<p><strong>ANTIGUO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SIMILAR</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>NUEVO</strong></p>"; stim_list_T_P = stim_list_T_P_1;
} else if (segundo_random == 2) {
  instrucciones_2 = "instrucciones_teclas_2.jpg"; ejemplo = "ejemplo_2.jpg"; texto_respuestas = "<p><strong>SIMILAR</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>NUEVO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ANTIGUO</strong></p>"; stim_list_T_P = stim_list_T_P_2;
} else if (segundo_random == 3) {
  instrucciones_2 = "instrucciones_teclas_3.jpg"; ejemplo = "ejemplo_3.jpg";  texto_respuestas = "<p><strong>NUEVO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ANTIGUO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SIMILAR</strong></p>"; stim_list_T_P = stim_list_T_P_3;
}

var instrucciones_tarea = {
    type:jsPsychInstructions,
    pages: [
    '<p>En la primera sección de la tarea se te pidió decidir a cerca de escenas y objetos.</p><p>En esta segunda sección se te presentarán una serie de imagenes de objetos.</p><p><strong>Tu tarea consiste en decidir de forma rápida y precisa para cada objeto si es: antiguo, similar o nuevo.</strong></p><p><strong>ANTIGUO:</strong> Si la imagen del objeto que observas es <strong>exactamente la misma</strong> a alguna que haya aparecido en la primera sección de la tarea.</p><p><strong>SIMILAR:</strong> Si la imagen del objeto es <strong> similar, más no idéntica </strong> a alguna que se haya presentado, esto quiere decir que puede estar representando el mismo tipo de objeto, pero con alguna(s) característica(s) diferente(s).</p><p><strong>NUEVO:</strong> Si el objeto que observas nunca se había presentado antes en la primera sección de la tarea.</p><p><strong>Presiona "continuar" para ver un ejemplo de la tarea</strong></p>',
    '<br>' + 
    '<img src= "instrucciones_t.jpg" style="width: 1000px; height: auto;"></img>' ,
    '<br>' +
    '<img src="' + ejemplo + '" style="width: 950px; height: auto;"></img>',
    '<br>' + 
    '<img src= "teclado_2.jpg" style="width: 950px; height: auto;"></img>',
    '<br>' +
    '<img src="' + instrucciones_2 + '" style="width: 950px; height: auto;"></img>',
    '<br>' +
    '<p><div style="font-size:22px;"><strong>Antes de comenzar realizarás una breve práctica para familiarizarte con la tarea.</strong></p><p> Las respuestas están basadas en las imagenes que viste en la práctica de la primera sección. <p><strong> En esta ocasión se te dará retroalimentación sobre la respuesta correcta, sin embargo esto no sucede en la tarea real. </p></strong><p>El objetivo es que identifiques la dinámica de la actividad. <p> Presiona "continuar" para leer la última instrucción antes de la práctica</p>'
  ],
    button_label_next: "CONTINUAR",
    button_label_previous: "ANTERIOR",
    show_clickable_nav: true,
    allow_keys: false
};

timeline.push(instrucciones_tarea);

var cursor_off = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "none";
  }
};
timeline.push(cursor_off);


////inicio de la práctica///////////

////////// AGREGARRRRRR JS ******************/////////

var inicio_practica_2 = {
  type: jsPsychImageKeyboardResponse,
  stimulus:"dedos_2.jpg",
  stimulus_height: 650,
  maintain_aspect_ratio: true,
  choices: ["v","n","b"]
};
timeline.push(inicio_practica_2);

var practica = {
  type: jsPsychImageKeyboardResponse,
  stimulus: jsPsych.timelineVariable("stimulus"),
  stimulus_duration: 3000,
  stimulus_height: 550,
  maintain_aspect_ratio: true,
    prompt: '<div style="font-size:20px; text-align: center;">' + texto_respuestas + '</div>',
    choices: ["V","N","B"],
  trial_duration: null,

data: {
     task: 'practica_recuerdo',
     correct_response: jsPsych.timelineVariable('correct_response'),
     tipo_estimulo: jsPsych.timelineVariable('tipo')
  },
  
  on_finish: function(data) {
    if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
      data.correct = true;
    } else {
      data.correct = false;
    }
  }
};

var feedback_2 = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 4000,
  choices:"NO_KEYS",
  stimulus: function() {
    var last_trial = jsPsych.data.get().last(1).values()[0];
    var tipo_estimulo = last_trial.tipo_estimulo;
    
    if (tipo_estimulo == "antiguo") {
      if (last_trial.correct) {
        return '<div style="font-size:25px;color:green;">¡Correcto! este es un objeto <strong style="color:black;">antiguo</strong> es decir, idéntico a alguno que viste en la primera sección </div>'+
       '<img src="feedback_t_a.jpg" style="width: 600px; height: auto;">';
      } else {
        return '<div style="font-size:25px;color:red;">Incorrecto, este es un objeto <strong style="color:black;">antiguo</strong> es decir, idéntico a alguno que viste en la primera sección </div>'+
       '<img src="feedback_t_a.jpg" style="width: 600px; height: auto;">';
      }
    } else if (tipo_estimulo == "similar") {
      if (last_trial.correct) {
        return '<div style="font-size:25px;color:green;">¡Correcto! este es un objeto <strong style="color:black;">similar</strong> es decir, parecido pero no idéntico a alguno que viste en la primera sección </div>'+
        '<img src="feedback_t_s.jpg" style="width: 500px; height: auto;">';
      } else {
        return '<div style="font-size:25px;color:red;">Incorrecto, este es un objeto <strong style="color:black;">similar</strong> es decir, parecido pero no idéntico a alguno que viste en la primera sección </div>'+
        '<img src="feedback_t_s.jpg" style="width: 500px; height: auto;">';
      }
    } else if (tipo_estimulo == "nuevo") {
      if (last_trial.correct) {
        return '<div style="font-size:25px;color:green;">¡Correcto! este es un objeto <strong style="color:black;">nuevo</strong> es decir, nunca se presentó en la primera sección </div>'
      } else {
        return '<div style="font-size:25px;color:red;">Incorrecto,este es un objeto <strong style="color:black;">nuevo</strong> es decir, nunca se presentó en la primera sección </div>';
      }
    }
  }
};

var procedimiento_practica_2 = {
  timeline:[ fixation, practica, feedback_2],
  timeline_variables: stim_list_T_P,
  randomize_order:true
};

timeline.push(procedimiento_practica_2);

var cursor_on = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "auto";
  }
};
timeline.push(cursor_on);

//////////LOOP 2///////////

// Repetir instrucciones y práctica si el participante lo considera necesario 
var repetir_practica_2 = {
  type: jsPsychSurveyMultiChoice,
  button_label: 'CONTINUAR',
  name: 'Repetir_practica', 
  questions: [
    {prompt: '<p style= "font-size:25px;"><strong> Has finalizado la práctica.</strong></p><p>Si te quedó alguna duda, selecciona la opción de "REPETIR" para volver a leer las intrucciones y realizar de nuevo la práctica.</p><p>Si todo está claro, selecciona "ACTIVIDAD".</p>', options: ["REPETIR", "ACTIVIDAD"], required: true}
  ]
};
timeline.push(repetir_practica_2);


// Condicional para repetir instrucciones y práctica 
var repetir_loop_2 = {
  timeline: [instrucciones_tarea, instrucciones_2, cursor_off, inicio_practica_2, procedimiento_practica_2, cursor_on, repetir_practica_2],
  conditional_function: function() {
    var dat_2 = jsPsych.data.getLastTrialData().values()[0];
    var answer_2 = dat_2.response.Q0;
    if(answer_2.includes("REPETIR") == true) {
      return true;
    } else {
      return false;
    }
  },
}
timeline.push(repetir_loop_2);


// Informacion inicio tarea de memoria 
var inicio_tarea_memoria ={
  type: jsPsychHtmlKeyboardResponse,
  stimulus:'<div style="font-size:25px;"><strong>¡Has concluido la práctica!</p><p>Para comenzar la tarea completa </strong> Por favor coloca tus dedos como lo hiciste en la práctica sobre las teclas “V” "B" y “N” <p>Cuando estés list@, ¡presiona cualquiera de ellas para comenzar! :)</p></strong></div>',
  choices: ["v","n","b"],
};
timeline.push(inicio_tarea_memoria);

//Quitar cursor utilizando un estilo css cargado como "no_mouse.css"
var cursor_off = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "none";
  }
};
timeline.push(cursor_off);

////////////////////////////////////
/////////INICIO TAREA MEMORIA ///////////
////////////////////////////////////

/////////agregar nuevo js************//////////////

var pruebaT={
    type:jsPsychImageKeyboardResponse,
    stimulus:jsPsych.timelineVariable("stimulus"),
    stimulus_height: 500,
    stimulus_duration: 3000,
    maintain_aspect_ratio: true,
    prompt: '<div style="text-align: center;">' + texto_respuestas + '</div>',
    choices: ["V","N","B"],
    save_trial_parameters: {
    stimulus: true,
    prompt: true //agregué el promt para ver el orden de presentación aunque lo conserva la ondición también
    //choices: true, //No necesito guardar las choices porque son siempre las mismas no tiene que ver con el orden 
      },
    data: { //se establecen los datos que se quieren registrar de la variable ensayo, respuesta del participante, cuál era la respuesta correcta, etc)
     task: 'response',
     tipo: jsPsych.timelineVariable('tipo'),
     contexto: jsPsych.timelineVariable('contexto'),
     correct_response: jsPsych.timelineVariable('correct_response'),
    },
    on_finish: function(data){ //al finalizar cada ensayo mediante este pluginAPI se compara la respuesta asignada a 'data' que provienen de lo almacenado en task: 'response', con la respuesta corecta correct_response y se almacena en la variable data.correct
      data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
      data.antiguo = jsPsych.pluginAPI.compareKeys(data.response, jsPsych.timelineVariable('antiguo'));
      data.similar = jsPsych.pluginAPI.compareKeys(data.response, jsPsych.timelineVariable('similar'));
      data.nuevo = jsPsych.pluginAPI.compareKeys(data.response, jsPsych.timelineVariable('nuevo'));
    }
  }; 

var cursor_off = {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "none";
  }
};
timeline.push(cursor_off);

var procedimiento_2= {
    timeline:[ fixation, pruebaT],
    randomize_order:true
};

//creo que esto podría adjuntarse en el otro condicional pero por ahora lo dejo así, porque visualmente me ayuda
if (segundo_random == 1) {
  procedimiento_2.timeline_variables = stim_list_T_1;
} else if (segundo_random == 2) {
  procedimiento_2.timeline_variables = stim_list_T_2;
} else if (segundo_random == 3) {
  procedimiento_2.timeline_variables = stim_list_T_3;
};
timeline.push(procedimiento_2);

var cursor_on= {
  type: jsPsychCallFunction,
  func: function(){
    document.body.style.cursor = "auto";
  }
};
timeline.push(cursor_on);

/////////////////////////////////
////////Final y preguntas////////
/////////////////////////////////


var conclusion_2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style="font-size:30px"><strong>¡Gracias por tus respuestas!</strong></p><p>Para finalizar, por favor responde algunas preguntas acerca de tu experiencia en esta tarea</p>',
  choices: ['CONTINUAR']
};

timeline.push(conclusion_2);

var problemas = {
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>¿Tuviste algún contratiempo (por ejemplo, problemas con tu computadora) que pudiera haber afectado tus respuestas?</strong></div>", 
      name: 'problemas', 
      options: ['SI', 'NO'], 
      required: true,
    }
  ],
};

var desempeno = {
type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>En general, ¿cómo calificarías tu desempeño en la tarea?</strong></p><p>La respuesta se relaciona con las respuestas correctas que crees haber tenido </p></div>", 
      name: 'desempeno', 
      options: ['MUY BUENO','BUENO','REGULAR','MALO','MUY MALO'], 
      required: true,
    }
  ],
};

var dificultad ={
  type: jsPsychSurveyMultiChoice,
  button_label:"CONTINUAR",
  questions: [
    {
      prompt: "<div style='font-size: 20px;'><strong>En general, ¿la dificultad de esta tarea te pareció: fácil, media, o difícil?</strong></div>", 
      name: 'dificultad', 
      options: ['FACIL', 'MEDIA', 'DIFICIL'], 
      required: true,
    }
  ],
};

var recuerdo = {
  type:jsPsychSurveyText,
  button_label:"CONTINUAR",
  name: 'recuerdo',
  preamble: "<div style='font-size: 20px;'><strong>¿Consideras que te fue más sencillo recordar ciertos objetos en comparación con otros?</strong></div>",
  questions: [
    {prompt: '<p>Si la respuesta es afirmativa escribe "SI" y por favor describe cuáles objetos y por qué crees que fueron más sencillos de recordar</p> <p> si la respuesta es negativa solo escribe "NO" </p> ',
    name: 'recuerdo', 
    required: true,
    },
  ]
};
  
var estrategia = {
  type:jsPsychSurveyText,
  button_label:"CONTINUAR",
  name: 'estrategia',
  preamble: "<div style='font-size: 20px;'><strong>¿Utilizaste alguna estrategia en particular para intentar recordar los objetos y responder si era Antiguo, Similar, o Nuevo?</strong></div>",
  questions: [
    {prompt: '<p>Si la respuesta es afirmativa escribe "SI" y por favor describe en qué consistió tu estrategia</p><p> Si la respuesta es negativa solo escribe "NO" </p> ',
    name: 'estrategia', 
    required: true,
    },
  ]
};

var extra = {
  type:jsPsychSurveyText,
  button_label:"CONTINUAR",
  preamble: "<div style='font-size: 20px;'><strong>Si tienes algún comentario o sugerencia por favor escríbelo, será bien recibido</strong></div>",
  questions: [
    {prompt: 'Si no es el caso, puedes presionar unicamente el botón de "CONTINUAR"',
    name: 'extra',
    required: false,
    },
  ]
};

var despedida= {
  type:jsPsychHtmlButtonResponse,
  stimulus: "<div style='font-size: 30px;'><p>La tarea ha terminado, sólo falta guardar los datos de tus respuestas.</p><p><strong>¡Muchas gracias por tu partipación!<p> :) </p></strong></div>",
  choices: ['GUARDAR DATOS']
};
timeline.push(problemas,desempeno,dificultad,recuerdo,estrategia,extra,despedida);

//////////////////////////////////////////////
///////// TERMINA EXPERIMENTO ////////////////
//////////////////////////////////////////////

timeline.push({
  type: jsPsychFullscreen,
  fullscreen_mode: false
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,  
  stimulus: "<div style='font-size: 20px;'><p><strong>Al presionar cualquier tecla se guardarán los datos.</p></strong><p><strong>Por favor, espera hasta que deje de dar vueltas el círculo para que terminen de cargar, cuando la pantalla quede en blanco puedes cerrar la página.</p></strong><p><strong>¡Gracias y hasta pronto!</p> </p></strong></div>"
});
    
const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "Uh1IVajIV2t7",
  filename: `${subject_id}.csv`,
  data_string: ()=>jsPsych.data.get().csv()
};
timeline.push(save_data);



jsPsych.run(timeline);

  </script>
</html>
